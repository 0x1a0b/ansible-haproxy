---
- name: Enable Service | haproxy
  lineinfile:
    state: present
    dest: /etc/default/haproxy
    regexp: 'ENABLED\='
    line: 'ENABLED=1'
  tags:
    - haproxy

- name: Directories Exists
  file:
    state: directory
    path: "{{ item }}"
    owner: "{{ haproxy_user }}"
    group: wcadmin
    mode: 0775
  with_items:
    - "{{ haproxy_runtime_root }}"
    - /etc/haproxy/fragments.d
  tags:
    - directory-structure
    - runtime-data
    - haproxy

- name: Upload Config Fragments | haproxy
  template:
    src: "etc/haproxy/fragments.d/{{ item.path }}"
    dest: "/etc/haproxy/fragments.d/{{ item.path }}"
  notify: Reload Service | haproxy
  when: item.when_condition
  with_items:
    - { path: 00-global, when_condition: yes }
    - { path: 01-defaults, when_condition: yes }
    - { path: 02-error-handling, when_condition: haproxy_error_handling_enabled }
    - { path: 03-stats, when_condition: haproxy_stats_enabled }
    - { path: 80-application, when_condition: haproxy_standard_configuration }
    - { path: 81-deployment, when_condition: haproxy_autodeploy_passthrough_enabled }
    - { path: 443-https, when_condition: haproxy_ssl_enabled }
  tags:
    - configuration
    - fragment-configuration
    - haproxy

- name: Assemble Config Fragments | haproxy
  assemble:
    src: /etc/haproxy/fragments.d
    dest: /etc/haproxy/haproxy.cfg
    delimiter: '### START FRAGMENT ###'
  tags:
    - configuration
    - fragment-configuration
    - haproxy
